/*!
 * jFile is “File uploading Ajax method for jQuery framework”.
 *
 * @author demorfi <demorfi@gmail.com>
 * @version 1.0
 * @source https://github.com/demorfi/jfile
 * @license http://opensource.org/licenses/MIT Licensed under MIT License
 */
(function(b){b.fn.jfile=function(c){var d=new a(this,c);d.init();return(d)};var a=function(d,c){this.version=1;this.options=b.extend(true,{name:"jfile",type:"",multiple:true,maxSize:0,allowMimeType:[],submit:false,autoSubmit:false,sizeImageScreen:300,url:"/",response:"text",useThrownErrors:true,params:{},callbacks:{init:null,addList:null,validateFiles:null,duplicate:null,validateSuccess:null,appendList:null,addFile:null,changeFile:null,dropFile:null,dragOver:null,submit:null,success:null,failed:null,upload:null,errorFile:function(i,e,f,j,h){var g=(this.addToList(j,{list:[e],size:e.size,length:1},f,h)[0]).removeData("jfileItem");this.changeStatus(j,"error",i);setTimeout(b.proxy(function(k){k.find(this.getClass("remove",true)).trigger("click.jfileRemove")},this,g),4000)},errorMime:function(e,f,h,g){this.getCallback("errorFile").call(this,this.getMessage("mimeError"),e,f,h,g)},errorSize:function(e,f,h,g){this.getCallback("errorFile").call(this,this.getMessage("sizeError"),e,f,h,g)},preview:function(e){e.stop().fadeIn(300)},previewOut:function(e){e.stop(false,true).fadeOut(300)},uploadProgress:function(f,e){f.find(this.getClass("progressPercent",true)).stop().animate({width:e+"%"},100)},uploadSuccess:function(e){var f=this.getMessage("upload").replace("{time}",(new Date().toLocaleFormat("%d.%m.%y %H:%M")));this.changeStatus(e,"success",f)},uploadBreak:function(e){this.changeStatus(e,"error",this.getMessage("break"))},uploadError:function(f,e){e=this.getOption("useThrownErrors")?e:this.getMessage("error");this.changeStatus(f,"error",e)}},animate:{add:{start:{height:0,"padding-top":0,"padding-bottom":0,opacity:0},end:{height:34,"padding-top":5,"padding-bottom":5,opacity:1}},remove:{height:0,"padding-top":0,"padding-bottom":0,opacity:0},time:500},messages:{dragInsertFile:"Drag file to load",sizeError:"Size exceeded",mimeError:"Invalid file format",remove:"Delete file from list",upload:"Uploaded: {time}","break":"Upload canceled",error:"Upload interrupted"},tpl:{addToList:'<div class="jfile-type"></div><div class="jfile-name">{name}</div><div class="jfile-size">{size}</div><div class="jfile-progress"><div class="jfile-progress-percent"></div></div><div class="jfile-remove"></div>'},"class":{wrapper:"jfile-wrapper",list:"jfile-list",name:"jfile-name",type:"jfile-type",size:"jfile-size",remove:"jfile-remove",progress:"jfile-progress",progressPercent:"jfile-progress-percent",uploadBreak:"jfile-upload-break",drag:"jfile-drag",dragObject:"jfile-drag-object",dragOver:"jfile-drag-over",error:"jfile-error",success:"jfile-success",imagePreview:"jfile-image-preview",successIndicator:"jfile-indicator-success",errorIndicator:"jfile-indicator-error",indicator:"jfile-indicator",fileExt:"jfile-ext",preview:"jfile-preview"}},c);this.$el=b(d);return(this)};a.prototype={init:function(){var d=this;var c=this.getOption("submit");if(c){if(/^(#|\.)/g.test(c)&&!b(c).data("jfileSubmit")){this.triggerSubmit=b(c).on("click.jfileSubmit",this,b.proxy(this.submit,this));b(c).data("jfileSubmit",this.triggerSubmit)}}b.each(this.$el,function(){if(b(this).attr("name")==b(this).data("jfile-id")){b(this).css({position:"absolute",left:"-99999px"})}else{b(this).wrap(b("<div>").addClass(d.getClass("wrapper"))).show()}var f=d.getOption("type");if(d.getOption("type")==""){var g=b(this).attr("type");f=g!="file"&&g!="button"?"range":g}var e=f.toLowerCase().charAt(0).toUpperCase()+f.slice(1);d.addEventType(this,e)});this.getCallback("init").call(this,this.$el)},addEventType:function(e,d){if(!b.isFunction(this["init"+d])){return(false)}var c=b(e).closest("form");if(c.length&&!this.getOption("submit")&&!c.data("jfileSubmit")){this.triggerSubmit=c.on("submit.jfileSubmit",this,b.proxy(this.submit,this)).data("jfileSubmit",this.triggerSubmit)}b(e).data("jfileSelf",this);b(e).attr("type")=="file"&&b(e).val("");this["init"+d].call(this,e);return(true)},changeStatus:function(e,c,d){var f=this;e.find(this.getClass("indicator",true)).remove();e.find(this.getClass("progress",true)).stop().fadeTo(500,!c?1:0,c?function(){b(this).hide().after(b("<div>").addClass(f.getClass("indicator "+c+"Indicator")).text(d).hide().fadeTo(500,1))}:b.noop)},getClass:function(d,c){if(d.indexOf(" ")!==-1){return(d.split(" ").map(b.proxy(function(e){if(e.length){return(this.getClass(e,c))}},this)).join(c?"":" "))}return((c?".":"")+this.options["class"][d])},getCallback:function(c){return(b.isFunction(this.options.callbacks[c])?this.options.callbacks[c]:b.noop)},getOption:function(c){return(this.options[c])},setOption:function(c,d){this.options[c]=d},getVersion:function(){return(this.version)},getAnimateOptions:function(c){return(this.options.animate[c])},getTemplate:function(c){return(this.options.tpl[c])},setTemplate:function(c,d){this.options.tpl[c]=d},getMessage:function(c){return(this.options.messages[c])},getList:function(d){var c=b(d).data("jfile-id");if(c){var e=b('[data-jfile-ref="'+c+'"]');if(e.length){return(this.getList(e))}var f=b("#"+c);return(f.length?f:false)}return(false)},getNameToFile:function(e){var d=b(e).data("jfileItemParent"),c=b(d?d:e);if(c.attr("type")=="file"&&c.attr("name").length){return(c.attr("name"))}return(this.getOption("name"))},addList:function(d){var c=b(d).find("ul");if(!c.length){c=b("<ul>").addClass(this.getClass("list")).prependTo(d);this.getCallback("addList").call(this,d)}return(c)},fileSize:function(d){var e=["b","Kb","Mb","Gb","Tb","Pb","Eb","Zb","Yb"],c=Math.floor(Math.floor(Math.log(d)/Math.log(1024)));return(Math.round(d/Math.pow(1024,c))+e[c])},getFileInfo:function(c){var d=/\.([^.\\/:*?"<>|\r\n]+$)/.exec(c.name);return({name:c.name,size:this.fileSize(c.size),type:c.type,ext:d?d[1].toLowerCase():""})},checkDuplicateFile:function(d,c){for(var e in c){if(c.hasOwnProperty(e)){e=c[e];if(e.name==d.name&&e.size==d.size){return(true)}}}return(false)},validateFiles:function(g,d){var k=this.getList(g),l=b(k).data("jfileList"),e=parseInt(l?l.size:0),m=l?l.list:[],n=this.getOption("maxSize"),f=this.getOption("allowMimeType").join("|").replace(/\*/g,".*").replace(/\//g,"\\/");var c={length:0,size:0,list:[],validate:false};if(b(d.currentTarget).hasClass(this.getClass("dragObject"))){g=d}if(!g.files||b.isEmptyObject(g.files)){return(false)}this.getCallback("validateFiles").call(this,g,k,d);for(var j=0;j<g.files.length;j++){var h=g.files[j];if(m.length&&this.checkDuplicateFile(h,m)){this.getCallback("duplicate").call(this,h,g,m,d);continue}if(n&&n<=Math.round((e+h.size)/1024)){this.getCallback("errorSize").call(this,h,g,k,d);continue}if(f.length&&!(new RegExp(f,"g")).test(h.type)){this.getCallback("errorMime").call(this,h,g,k,d);continue}c.list[c.length]=h;c.length++;e+=h.size;c.size+=h.size;c.validate=true;this.getCallback("validateSuccess").call(this,g,k,h,c,d)}return(c.length?c:false)},addFilesToList:function(f,e){var g=b(f).data("jfileList"),c=g?g:[],d=b(f).closest(this.getClass("wrapper",true));!d.length&&b(f).wrap(b("<div>").addClass(this.getClass("wrapper")));if(c.length&&this.getOption("multiple")&&e.validate){b(f).data("jfileList",{list:b.merge(c.list,e.list),length:c.length+e.length,size:c.size+e.size})}else{e.validate&&b(f).data("jfileList",e)}this.getCallback("appendList").call(this,f,e)},addToList:function(j,c,e,d){if(!c.length){return(j)}if(!j&&c.validate){b(e).data("jfileList",c);return(j)}this.addFilesToList(j,c);var k=[];for(var g=0;g<c.list.length;g++){var f=c.list[g],h=this.getFileInfo(f),o=this.addList(j),m=FileReader!==undefined&&/^image\/.*$/g.test(h.type),l=this.getTemplate("addToList").replace("{name}",h.name).replace("{size}",h.size);var n=b("<li>").data("jfileItem",f).data("jfileItemParent",e).css(this.getAnimateOptions("add").start).stop().animate(this.getAnimateOptions("add").end,this.getAnimateOptions("time")).append(l);n.on({jfileUpload:b.proxy(function(i,p){return(this.upload([{list:p,item:i,file:b(i).data("jfileItem")}]))},this,n,j),jfileRemove:b.proxy(function(i){return(b(i).find(this.getClass("remove",true).trigger("click.jfileRemove")))},this,n,j)});n.find(this.getClass("type",true)).addClass(this.getClass("fileExt"+(m?" preview":""))+" "+h.ext).on({"click.jfileType":b.proxy(function(q,r){if(FileReader!==undefined&&/^image\/.*$/g.test(q.type)){var p=b(r.currentTarget).find("img");if(p.length){this.getCallback("preview").call(this,p,r)}else{b("<img>").addClass(this.getClass("imagePreview")).appendTo(r.currentTarget).hide();p=b(r.currentTarget).find("img").css({top:b(r.currentTarget).height()/2,left:b(r.currentTarget).width()+2});var i=new FileReader();i.onload=b.proxy(function(t,s){b(this).attr("src",s.target.result).hide();setTimeout(b.proxy(function(x,w){var y=x.getOption("sizeImageScreen"),v=b(this).width(),u=b(this).height();if(v>u&&v>y){b(this).attr("width",y)}else{if(u>y){b(this).attr("height",y)}}x.getCallback("preview").call(x,this,w)},this,t,s),100)},p,this);i.readAsDataURL(q)}}},this,f),"mouseout.jfileType":b.proxy(function(i,p){if(FileReader!==undefined&&/^image\/.*$/g.test(i.type)){this.getCallback("previewOut").call(this,b(p.currentTarget).find("img"),p)}},this,f)});n.find(this.getClass("remove",true)).attr("title",this.getMessage("remove")).on("click.jfileRemove",b.proxy(function(s,y,q){var x=b(q.currentTarget).closest("ul"),p=b(q.currentTarget).closest("li"),r=x.parent().data("jfileList"),t=p.data("jfileItem");if(r){for(var w=0;w<r.length;w++){var v=r.list[w].name,u=r.list[w].size;if(v!==undefined&&v==t.name&&u==t.size){r.list.splice(w,1);r.length--;if(r.size&&t.size){r.size-=t.size}}}}b(q.currentTarget).trigger("jfileUploadBreak");x.parent().data("jfileList",r);p.addClass("jfileAnimate").stop().animate(this.getAnimateOptions("remove"),this.getAnimateOptions("time"),b.proxy(function(i){var z=b(this).closest("ul");b(this).remove();if(!b(z).find("li").length){b(z).remove();b(i).val("")}},p,s))},this,e,d));n.appendTo(o);k.push(n);this.getCallback("addFile").call(this,n,h,j,c)}return(k)},initFile:function(c){b(c).attr({accept:this.getOption("allowMimeType").join(","),multiple:this.getOption("multiple")?"multiple":false});b(c).on("change.jfileItem",b.proxy(function(d,f){this.getCallback("changeFile").call(this,d,f);var g=this.getList(d),e=this.validateFiles(d,f);if(e.length){this.addToList(g,e,d,f)}if(this.getOption("autoSubmit")&&!this.triggerSubmit){this.submit(f)}},this,c))},initButton:function(c){if(b(c).data("jfile-ref")){b(c).on("click.jfileButton",b.proxy(function(d){b('[data-jfile-id="'+b(d).data("jfile-ref")+'"]').val("").trigger("click.jfileItem")},this,c))}},initRange:function(c){if(!FileReader){return}b(c).append(b("<div>").addClass(this.getClass("drag")).append(b("<div>").addClass(this.getClass("dragObject")).text(this.getMessage("dragInsertFile"))));b(c).find(this.getClass("dragObject",true)).on({"dragenter.jfileRange":function(){return(false)},"dragover.jfileRange":b.proxy(function(d,e){b(e.currentTarget).addClass(this.getClass("dragOver"));this.getCallback("dragOver").call(this,e);return(false)},this,c),"dragleave.jfileRange":b.proxy(function(d,e){b(e.currentTarget).removeClass(this.getClass("dragOver"));return(false)},this,c),"drop.jfileRange":b.proxy(function(d,f){f.preventDefault();this.getCallback("dropFile").call(this,f);var g=this.getList(d),e=this.validateFiles(d,b.extend(f,{files:f.originalEvent.dataTransfer.files}));if(e.length){this.addToList(g,e,d,f)}if(this.getOption("autoSubmit")&&!this.triggerSubmit){this.submit(f)}return(false)},this,c)})},submit:function(e){e.preventDefault();e.stopPropagation();var c,f=b(e.currentTarget).find(this.getClass("list",true)),d=b(e.currentTarget).find(this.getClass("wrapper",true)+" input");if(f.length){c=f.map(function(g){return(b(this).find("li").map(b.proxy(function(m,k,h){var l=b(h).data("jfileItem");if(l&&!b(h).data("jfileUpload")){return({list:this,item:h,file:l})}},this,g)).get())}).get()}else{c=d.map(function(){var g=b(this).data("jfileList");if(g&&g.list){return((b(this).data("jfileList").list).map(b.proxy(function(h){return({list:this,item:this,file:h})},this)))}}).get()}this.getCallback("submit").call(this,c,e);if(c.length&&this.getCallback("upload").call(this,c,e)!==true){b.extend(c,{el:e.currentTarget,event:e});this.upload(c)}},upload:function(f){if(!FormData){this.uploadIframe(f);return}var e=new FormData(),g=this.getOption("params");for(var d in f){if(f.hasOwnProperty(d)&&f[d].item){var h=this.getNameToFile(f[d].item);if(this.getOption("multiple")&&!(/\[?(.*)]/g.test(h))){h+="[]"}e.append(h,f[d].file)}}if(b.isEmptyObject(g)||b.isArray(g)){for(var c in g){if(g.hasOwnProperty(c)){if(b.isArray(g)){e.append(g[c].name,g[c].value)}else{e.append(c,g[c])}}}}b.ajax({xhr:function(){var i=new XMLHttpRequest();i.upload.addEventListener("progress",b.proxy(function(m){if(m.lengthComputable){for(var k in this.request){if(this.request.hasOwnProperty(k)){var l=this.request[k];if(l.file){var j=Math.ceil((m.loaded*100)/l.file.size);if(!b(l.item).data("jfileUpload")){b(l.item).on("jfileUploadBreak",{self:this.self,request:this.request,index:k},b.proxy(function(q,p){var n=b(p.currentTarget).addClass(this.getClass("uploadBreak")).data("jfileUpload");if(n&&n.xhr){var o=b(q.item),r=b(p.currentTarget).closest(this.getClass("list",true));n.xhr.abort();if(!o.data("uploadSuccess")&&!o.data("uploadBreak")){o.data("uploadBreak",true);this.getCallback("uploadBreak").call(this,o,r,q,p)}}}),this,l)}b(l.item).data("jfileUpload",{percent:j,file:l,upload:false,xhr:i});this.self.getCallback("uploadProgress").call(this.self,b(l.item),j,l)}}}}},this),false);return(i)},type:"POST",url:this.getOption("url"),data:e,dataType:this.getOption("response"),cache:false,contentType:false,processData:false,request:f,self:this,success:function(n,i,o){var k=o.getResponseHeader("Date");for(var j in this.request){if(this.request.hasOwnProperty(j)){var m=this.request[j],l=b(m.item);l.data("jfileUpload",{percent:100,file:m,upload:true,date:k}).data("uploadSuccess",true);this.self.getCallback("uploadProgress").call(this.self,l,100,m);this.self.getCallback("uploadSuccess").call(this.self,l,n,this.request,o)}}this.getCallback("success").call(this,n,this.request,o)},error:function(m,i,k){for(var j in this.request){if(this.request.hasOwnProperty(j)){var l=b(this.request[j].item);this.self.getCallback("uploadError").call(this.self,l,k.toString(),this.request,m)}}this.self.getCallback("failed").call(this.self,k.toString(),this.request,m)}})},uploadIframe:function(h){var g=b(h[0].list).closest("form");if(b(g).next("iframe").length){return}var f=b(g).find('[type="file"]'),i=this.getOption("params"),c=b('<form method="POST" enctype="multipart/form-data" target="jfile-frame">').attr("action",this.getOption("url"));b(f).each(function(){c.append(b(this).clone())});if(b.isEmptyObject(i)||b.isArray(i)){for(var d in i){if(i.hasOwnProperty(d)){if(b.isArray(i)){c.append(b('<input type="hidden" name="'+i[d].name+'" value="'+i[d].value+'" />'))}else{c.append(b('<input type="hidden" name="'+d+'" value="'+i[d]+'" />'))}}}}var e=b('<iframe name="jfile-frame" src="data:text/plain;base64">').css({position:"absolute",left:"-10000px"}).append(c).insertAfter(g);e.on("load",b.proxy(function(o,l){var j=l.currentTarget,n=j.contentDocument?j.contentDocument:j.contentWindow.document,k=n.body.innerHTML;if(this.getOption("response")=="json"){try{k=b.parseJSON(k)}catch(m){}}this.getCallback("success").call(this,k);b(e).remove()},this,e)).children("form").submit()}};b(function(){b(".jfile-trigger").jfile()});Date.prototype.toLocaleFormat=function(f){var d={y:this.getYear()+1900,m:this.getMonth()+1,d:this.getDate(),H:this.getHours(),M:this.getMinutes(),S:this.getSeconds()};for(var e in d){if(d.hasOwnProperty(e)){var c=d[e];f=f.replace("%"+e,c<10?"0"+c:c)}}return(f)}})(jQuery);